## Endpoint definitions

paths:
  /global-listeners/user-task:
    post:
      x-eventually-consistent: false
      tags:
        - Global listener
      operationId: createGlobalTaskListener
      summary: Create global user task listener
      description: Create a new global user task listener.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGlobalTaskListenerRequest'
        required: true
      responses:
        "201":
          description: The global user task listener was created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalTaskListenerResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "409":
          description: A global listener with this id already exists.
          content:
            application/problem+json:
              schema:
                $ref: "problem-detail.yaml#/components/schemas/ProblemDetail"
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'
        "503":
          $ref: 'common-responses.yaml#/components/responses/ServiceUnavailable'

  /global-listeners/user-task/{id}:
    get:
      x-eventually-consistent: true
      tags:
        - Global listener
      operationId: getGlobalTaskListener
      summary: Get global user task listener
      description: Get a global user task listener by its id.
      parameters:
        - name: id
          in: path
          required: true
          description: The id of the global user task listener.
          schema:
            $ref: 'identifiers.yaml#/components/schemas/GlobalListenerId'
      responses:
        "200":
          description: The global user task listener is successfully returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalTaskListenerResult'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "404":
          description: The global user task listener with the given id was not found.
          content:
            application/problem+json:
              schema:
                $ref: "problem-detail.yaml#/components/schemas/ProblemDetail"
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

    put:
      x-eventually-consistent: false
      tags:
        - Global listener
      operationId: updateGlobalTaskListener
      summary: Update global user task listener
      description: Updates a global user task listener.
      parameters:
        - name: id
          in: path
          required: true
          description: The id of the global user task listener to update.
          schema:
            $ref: 'identifiers.yaml#/components/schemas/GlobalListenerId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateGlobalTaskListenerRequest'
        required: true
      responses:
        "200":
          description: The global listener was updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalTaskListenerResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "404":
          description: The global user task listener was not found.
          content:
            application/problem+json:
              schema:
                $ref: "problem-detail.yaml#/components/schemas/ProblemDetail"
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'
        "503":
          $ref: 'common-responses.yaml#/components/responses/ServiceUnavailable'

    delete:
      x-eventually-consistent: false
      tags:
        - Global listener
      operationId: deleteGlobalTaskListener
      summary: Delete global user task listener
      description: Deletes a global user task listener.
      parameters:
        - name: id
          in: path
          required: true
          description: The id of the global user task listener to delete.
          schema:
            $ref: 'identifiers.yaml#/components/schemas/GlobalListenerId'
      responses:
        "204":
          description: The global listener was deleted successfully.
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "404":
          description: The global user task listener was not found.
          content:
            application/problem+json:
              schema:
                $ref: "problem-detail.yaml#/components/schemas/ProblemDetail"
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'
        "503":
          $ref: 'common-responses.yaml#/components/responses/ServiceUnavailable'

  /global-listeners/user-task/search:
    post:
      x-eventually-consistent: true
      tags:
        - Global listener
      operationId: searchGlobalTaskListeners
      summary: Search global user task listeners
      description: Search for global user task listeners based on given criteria.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GlobalTaskListenerSearchQueryRequest'
      responses:
        "200":
          description: The global user task listener search result.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalTaskListenerSearchQueryResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

## Schema definitions

components:
  schemas:
    # Enumerations
    GlobalListenerSourceEnum:
      type: string
      enum:
        - CONFIGURATION
        - API
      description: How the global listener was defined.
    GlobalTaskListenerEventTypeEnum:
      type: string
      enum:
        - all
        - creating
        - assigning
        - updating
        - completing
        - canceling
      description: The event type that triggers the user task listener.

    # Common
    GlobalListenerBase:
      type: object
      properties:
        type:
          description: The name of the job type, used as a reference to specify which job workers request the respective listener job.
          type: string
          example: order-items
        retries:
          description: Number of retries for the listener job.
          type: integer
        afterNonGlobal:
          description: Whether the listener should run after model-level listeners.
          type: boolean
        priority:
          description: The priority of the listener. Higher priority listeners are executed before lower priority ones.
          type: integer
    GlobalTaskListenerBase:
      type: object
      allOf:
        - $ref: '#/components/schemas/GlobalListenerBase'
      properties:
        eventTypes:
          $ref: '#/components/schemas/GlobalTaskListenerEventTypes'
    GlobalTaskListenerEventTypes:
      description: List of user task event types that trigger the listener.
      type: array
      items:
        $ref: '#/components/schemas/GlobalTaskListenerEventTypeEnum'

    # CRUD Requests
    CreateGlobalTaskListenerRequest:
      type: object
      required:
        - id
        - type
        - eventTypes
      allOf:
        - $ref: '#/components/schemas/GlobalTaskListenerBase'
      properties:
        id:
          $ref: 'identifiers.yaml#/components/schemas/GlobalListenerId'
    UpdateGlobalTaskListenerRequest:
      type: object
      required:
        - type
        - eventTypes
      allOf:
        - $ref: '#/components/schemas/GlobalTaskListenerBase'

    # CRUD Responses
    GlobalTaskListenerResult:
      type: object
      allOf:
        - $ref: '#/components/schemas/GlobalTaskListenerBase'
      properties:
        id:
          $ref: 'identifiers.yaml#/components/schemas/GlobalListenerId'
        source:
          $ref: '#/components/schemas/GlobalListenerSourceEnum'

    # Search Requests
    GlobalTaskListenerSearchQueryRequest:
      description: Global listener search query request.
      additionalProperties: false
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryRequest'
      properties:
        sort:
          description: Sort field criteria.
          type: array
          items:
            $ref: '#/components/schemas/GlobalTaskListenerSearchQuerySortRequest'
        filter:
          description: The global listener search filters.
          allOf:
            - $ref: '#/components/schemas/GlobalTaskListenerSearchQueryFilterRequest'
    GlobalTaskListenerSearchQuerySortRequest:
      type: object
      properties:
        field:
          description: The field to sort by.
          type: string
          enum:
            - id
            - type
            - afterNonGlobal
            - priority
            - source
        order:
          $ref: 'search-models.yaml#/components/schemas/SortOrderEnum'
      required:
        - field
    GlobalTaskListenerSearchQueryFilterRequest:
      description: Global listener filter request.
      type: object
      properties:
        id:
          description: Id of the global listener.
          allOf:
            - $ref: 'filters.yaml#/components/schemas/StringFilterProperty'
        type:
          description: Job type of the global listener.
          allOf:
            - $ref: 'filters.yaml#/components/schemas/StringFilterProperty'
        retries:
          description: Number of retries of the global listener.
          allOf:
            - $ref: 'filters.yaml#/components/schemas/IntegerFilterProperty'
        eventTypes:
          description: Event types of the global listener.
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/GlobalTaskListenerEventTypeFilterProperty'
        afterNonGlobal:
          description: Whether the listener runs after model-level listeners.
          type: boolean
        priority:
          description: Priority of the global listener.
          allOf:
            - $ref: 'filters.yaml#/components/schemas/IntegerFilterProperty'
        source:
          description: How the global listener was defined.
          allOf:
            - $ref: '#/components/schemas/GlobalListenerSourceFilterProperty'
    GlobalListenerSourceFilterProperty:
      description: Global listener source property with full advanced search capabilities.
      type: object
      oneOf:
        - type: string
          title: Exact match
          description: Matches the value exactly.
          allOf:
            - $ref: '#/components/schemas/GlobalListenerSourceEnum'
        - $ref: '#/components/schemas/AdvancedGlobalListenerSourceFilter'
    AdvancedGlobalListenerSourceFilter:
      title: Advanced filter
      description: Advanced global listener source filter.
      type: object
      properties:
        $eq:
          description: Checks for equality with the provided value.
          allOf:
            - $ref: '#/components/schemas/GlobalListenerSourceEnum'
        $neq:
          description: Checks for inequality with the provided value.
          allOf:
            - $ref: '#/components/schemas/GlobalListenerSourceEnum'
        $exists:
          description: Checks if the current property exists.
          type: boolean
        $in:
          description: Checks if the property matches any of the provided values.
          type: array
          items:
            $ref: '#/components/schemas/GlobalListenerSourceEnum'
        $like:
          $ref: "filters.yaml#/components/schemas/LikeFilter"
    GlobalTaskListenerEventTypeFilterProperty:
      description: Global listener event type property with full advanced search capabilities.
      type: object
      oneOf:
        - type: string
          title: Exact match
          description: Matches the value exactly.
          allOf:
            - $ref: '#/components/schemas/GlobalTaskListenerEventTypeEnum'
        - $ref: '#/components/schemas/AdvancedGlobalTaskListenerEventTypeFilter'
    AdvancedGlobalTaskListenerEventTypeFilter:
      title: Advanced filter
      description: Advanced global listener event type filter.
      type: object
      properties:
        $eq:
          description: Checks for equality with the provided value.
          allOf:
            - $ref: '#/components/schemas/GlobalTaskListenerEventTypeEnum'
        $neq:
          description: Checks for inequality with the provided value.
          allOf:
            - $ref: '#/components/schemas/GlobalTaskListenerEventTypeEnum'
        $exists:
          description: Checks if the current property exists.
          type: boolean
        $in:
          description: Checks if the property matches any of the provided values.
          type: array
          items:
            $ref: '#/components/schemas/GlobalTaskListenerEventTypeEnum'
        $like:
          $ref: "filters.yaml#/components/schemas/LikeFilter"

    # Search Responses
    GlobalTaskListenerSearchQueryResult:
      description: Global listener search query response.
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryResponse'
      properties:
        items:
          description: The matching global listeners.
          type: array
          items:
            $ref: '#/components/schemas/GlobalTaskListenerResult'
